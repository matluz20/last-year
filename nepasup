<?php

// ce script en php permet l'insertion et la creation du compte 


if(isset($_POST['envoi'])){
if(isset($_FILES['image'])){

$recup_username = "tototototoosobbd";
$recup_name = $_POST['name'];
$recup_last_name = $_POST['last_name'];
$recup_password = "toto123";
$recup_email = $_POST['email'];
$recup_image = $_POST['image'];
$recup_statut = "pending" ; // status acheteur par defaut !
$user_created = 0;



//_________________________________________________________

// verification de la bonne saisie des informations 


if($recup_username != ""){


    // chiffrement du mot de passe
    $hashed_password = password_hash($recup_password, PASSWORD_DEFAULT);

    // connexion à la base de données 

    $host = '91.173.60.180'; 
    $dbname = 'projet_web';   
    $username = 'rs2';  
    $password = 'Toto123#';

    try {
        // Connexion à la base de données
        $conn = new PDO("mysql:host=$host;dbname=$dbname", $username, $password);
        $conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
        // Vérifier si l'utilisateur possède déjà un compte
        $req1 = $conn->prepare("SELECT * FROM `Utilisateur` WHERE username = :username");
        $req1->bindParam(':username', $recup_username, PDO::PARAM_STR);
        $req1->execute();
        $donnes = $req1->fetch();
    
        if (!$donnes) { // Si l'utilisateur n'existe pas
            // Préparer l'insertion des données
            $sql = "INSERT INTO `Utilisateur` (`username`, `password`, `statut`, `email`, `name`, `last_name`, `image_data`)
                    VALUES (:username, :password, :statut, :email, :name, :last_name, :images)";
            $stmt = $conn->prepare($sql);
    
            // Charger l'image en binaire
            $image_data = file_get_contents($recup_image);
    
            // Lier les paramètres
            $stmt->bindParam(':username', $recup_username, PDO::PARAM_STR);
            $stmt->bindParam(':password', $hashed_password, PDO::PARAM_STR);
            $stmt->bindParam(':statut', $recup_statut, PDO::PARAM_STR);
            $stmt->bindParam(':images', $image_data, PDO::PARAM_LOB);
            $stmt->bindParam(':email', $recup_email, PDO::PARAM_STR);
            $stmt->bindParam(':name', $recup_name, PDO::PARAM_STR);
            $stmt->bindParam(':last_name', $recup_last_name, PDO::PARAM_STR);
    
            // Exécuter la requête
            $stmt->execute();
            echo "Inscription réussie !";
            $user_created = 1;

        }
    } catch (PDOException $e) {
        echo "Erreur : " . $e->getMessage();
    } finally {
        // Fermer la connexion
        $conn = null;
    }
    
        // l'envoi du message confirmant l'inscription du user 
        
            if($user_created == 1){

            $target_dir = "images/";
            $imageFileType = strtolower(pathinfo($_FILES["image"]["name"],PATHINFO_EXTENSION));
            $imageFileName = pathinfo($_FILES["image"]["name"], PATHINFO_FILENAME);
            $imageFileName = str_replace(' ', '', $imageFileName);

            $new_filename = $recup_name . "." . $imageFileName . "." . $imageFileType;

            $target_file = $target_dir . $new_filename;

            $uploadOk = 1;

            // Vérification du type de fichier
            if (!in_array($imageFileType, ['jpg', 'jpeg', 'png', 'gif', 'webp'])) {
                echo '<script type="text/javascript">'; 
                echo 'alert("Seuls les fichiers JPG, JPEG, PNG, WEBP et GIF sont autorisés.<br>");'; 
                echo 'window.location.href = "/";'; // mettre le lien de la page de connexion
                echo '</script>';
                exit;
                $uploadOk = 0;
            }

            // Vérification de la taille du fichier
            if ($_FILES["image"]["size"] > 500000) {

                echo '<script type="text/javascript">'; 
                echo 'alert("Le fichier est trop volumineux (taille maximale : 500 Ko).<br>");'; 
                echo 'window.location.href = "/";'; // mettre le lien de la page de connexion
                echo '</script>';
                exit;
                $uploadOk = 0;
            }
            // Vérification si le fichier existe déjà
            if (file_exists($target_file)) {
                echo '<script type="text/javascript">'; 
                echo 'alert("Une erreur est survenue. Nous vous conseillons de contacter l\'équipe administration\n");';
                echo 'window.location.href = "/";'; 
                echo '</script>';
                exit;
                $uploadOk = 0;
            }

            if ($uploadOk == 1) {
                if (move_uploaded_file($_FILES["image"]["tmp_name"], $target_file)) {
                    echo "";
                } else {

                    echo '<script type="text/javascript">'; 
                    echo 'Une erreur est survenue lors de l upload du fichier<br>");'; 
                    echo 'window.location.href = "/";'; // mettre le lien de la page de connexion
                    echo '</script>';
                    exit;
                }
            }

            if($recup_email != ""){

                $subject = "Bienvenue sur Facil'Access !";
                $message = 'Bonjour ' . $recup_name . ",
    
    
                Nous sommes ravis de vous accueillir sur notre outil ! Votre inscription a été prise en compte et nous sommes impatients 
                de vous accompagner dans votre utilisation de nos services.
                
                Afin de valider la création de votre compte, nous vous demandons de bien vouloir vous rendre à la salle de sport voulu.
    
                Nhésitez pas à nous contacter si vous avez des questions ou des problèmes lors de votre utilisation de notre service.
    
                Encore une fois, merci de votre confiance et à bientôt !
    
                Cordialement,
                L'équipe Facil'Access ";
    
    
                $headers = "From: ne.pas.repondre.choose.me@gmail.com\r\n";
                $headers .= "Reply-To: matondoluzolo20@gmail.com\r\n";
                $headers .= "Content-Type: text/plain; charset=UTF-8\r\n";
    
    
                $mail_sent = mail($recup_email, $subject, $message, $headers);
    
                }

            if($recup_statut == "pending"){

                echo '<script type="text/javascript">'; 
                echo 'alert("Votre compte est en cours de validation. Un e-mail va vous être communiqué.");'; 
                echo 'window.location.href = "/";'; // mettre le lien de la page de connexion
                echo '</script>';
        
            }

            }
            else{
                echo '<script type="text/javascript">'; 
                echo 'alert("Vous possedez déjà un compte. Veuillez vous connecter");'; 
                echo 'window.location.href = "/";'; // mettre le lien de la page de connexion
                echo '</script>';
            }
            


}
// renvoyer un message d'erreur si les variables n'ont pas été saisies et redirection à la page d'inscription : 
else{
    echo '<script type="text/javascript">'; 
    echo 'alert("Veillez saisir toutes les informations");';
    echo 'window.location.href = "inscription.php";'; // mettre le lien de la page d'inscription
}


    }
}



?>